---
import BaseLayout from "../../layouts/BaseLayout.astro";
import HorizontalCard from "../../components/HorizontalCard.astro";
import { getCollection } from "astro:content";

// â”€â”€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— â”€
const { tag } = Astro.params;

// â”€â”€ è¨˜äº‹ãƒ¡ã‚¿å–å¾— â”€
const all = await getCollection("articles");
const targets = all.filter((a) => (a.data.tags ?? []).includes(tag));

// â”€â”€ å„è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã® 001.jpg ã‚’é™çš„ import â”€
const thumbs = import.meta.glob(
  "../../content/articles/*/001.{jpg,jpeg,png}",
  { eager: true, import: "default" }
);
const thumbBySlug = Object.fromEntries(
  Object.entries(thumbs).map(([p, mod]) => [p.split("/").at(-2), mod])
);

// â”€â”€ ã‚¿ã‚°ä¸€è¦§ç”Ÿæˆï¼ˆé™çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ â”€
export async function getStaticPaths() {
  const set = new Set<string>();
  (await getCollection("articles")).forEach((a) => a.data.tags?.forEach((t) => set.add(t)));
  return [...set].map((t) => ({ params: { tag: t } }));
}
---

<BaseLayout
  title={`ã‚¿ã‚°: ${tag} | ã‚ã•ãŠã¨ã¿ã©ã‚Š`}
  description={`${tag} ã«é–¢é€£ã™ã‚‹è¦³å¯Ÿè¨˜äº‹ä¸€è¦§`}
  image="/ogp.png"
  url={`https://isuku.jp/tags/${encodeURIComponent(tag)}`}
  sideBarActiveItemID="articles"
>
  <section class="max-w-4xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-8">ğŸ· ã‚¿ã‚°: {tag}</h1>

    {targets.length === 0 ? (
      <p class="text-gray-500 dark:text-gray-400">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    ) : (
      <div class="space-y-6">
        {targets.map(({ slug, data }) => {
          // Front-matter > è‡ªå‹•ã‚µãƒ ãƒã®é †ã§æ¡ç”¨
          let img: any = data.image;
          if (!img) img = thumbBySlug[slug];
          if (typeof img === "string" && !img.startsWith("/")) {
            img = thumbBySlug[slug] ?? img;
          }

          return (
            <div class="article-card">
              <HorizontalCard
                title={data.title}
                desc={data.description}
                img={img}
                url={`/articles/${slug}`}
                badge="ã‚ã•ãŠã¨ã¿ã©ã‚Š"
                tags={data.tags}
                pubDate={data.pubDate}
              />
            </div>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
